## transport-app

[![codecov](https://codecov.io/gh/Ignaciojeria/transport-app/branch/main/graph/badge.svg)](https://codecov.io/gh/Ignaciojeria/transport-app) [![Go Report Card](https://goreportcard.com/badge/github.com/Ignaciojeria/transport-app)](https://goreportcard.com/report/github.com/Ignaciojeria/transport-app)


# üîÑ Propagaci√≥n de Contexto en Transport App

En esta aplicaci√≥n utilizamos OpenTelemetry Baggage para propagar contexto entre componentes (API ‚Üí eventos Pub/Sub ‚Üí consumidores) de forma trazable, desacoplada y estandarizada.

---

## üßæ Headers del API

El consumidor de la API debe enviar los siguientes headers en cada request:

| Header         | Ejemplo              | Descripci√≥n                            |
|----------------|----------------------|----------------------------------------|
| `organization` | `2-CL`               | ID del tenant + pa√≠s (`tenantId-country`) |
| `consumer`     | `CONSUMER_EXAMPLE`   | Identificador del consumidor del API   |
| `commerce`     | `COMMERCE_EXAMPLE`   | Identificador del comercio             |

Estos headers son procesados por un middleware que:

- Desglosa el `organization` en `tenant.id` y `tenant.country`.
- Carga todos los valores como `baggage` en el contexto de OpenTelemetry.

---

## üß† OpenTelemetry Baggage Keys

Estas claves viven dentro del contexto propagado (`context.Context`) y son visibles desde trazas (Jaeger, OpenObserve, etc).

| Clave Baggage       | Ejemplo              | Fuente               |
|---------------------|----------------------|----------------------|
| `tenant.id`         | `2`                  | Derivado de `organization` |
| `tenant.country`    | `CL`                 | Derivado de `organization` |
| `business.consumer` | `CONSUMER_EXAMPLE`   | Header `consumer`    |
| `business.commerce` | `COMMERCE_EXAMPLE`   | Header `commerce`    |
| `event.type`        | `orderSubmitted`     | Inyectado por c√≥digo |
| `entity.type`       | `order`              | Inyectado por c√≥digo |

---

## üì¶ Pub/Sub Message Attributes

Cuando se publica un evento (como `orderSubmitted`), los atributos del contexto son exportados al mensaje en formato `camelCase`:

```json
{
  "tenantId": "2",
  "tenantCountry": "CL",
  "consumer": "CONSUMER_EXAMPLE",
  "commerce": "COMMERCE_EXAMPLE",
  "eventType": "orderSubmitted",
  "entityType": "order"
}
```


## üìå Convenci√≥n de Campos para Direcciones en Chile

| Campo en JSON                | Descripci√≥n                      | Ejemplo                       |
| ---------------------------- | --------------------------------- | ----------------------------- |
| `addressInfo.addressLine1` | Calle y n√∫mero                    | `inglaterra 59`                    |
| `addressInfo.addressLine2` | Informaci√≥n adicional (opcional)  | `dpto 2214`                        |
| `addressInfo.district`     | Comuna                            | `la florida`                       |
| `addressInfo.province`     | Provincia                         | `santiago`                         |
| `addressInfo.state`        | Regi√≥n                            | `regi√≥n metropolitana de santiago` |
| `addressInfo.latitude`     | Latitud                           | `-33.5204181`                      |
| `addressInfo.longitude`    | Longitud                          | `-70.6006178`               |      
---

## üåê Ejemplos de Direcciones en Chile

### üè¢ Ejemplo en Santiago (con departamento)

```json
{
  "addressInfo": {
    "addressLine1": "av providencia 1234",
    "addressLine2": "depto 1202",
    "district": "providencia",
    "province": "santiago",
    "state": "regi√≥n metropolitana de santiago",
    "latitude": -33.4263,
    "longitude": -70.6200
  }
}
```

### üèôÔ∏è Ejemplo en Santiago (sin departamento)

```json
{
  "addressInfo": {
    "addressLine1": "avenida las condes 7890",
    "addressLine2": "",
    "district": "las condes",
    "province": "santiago",
    "state": "regi√≥n metropolitana de santiago",
    "latitude": -33.4085,
    "longitude": -70.5666
  }
}
```

## üìå Convenci√≥n de Campos para Direcciones en M√©xico

| Campo en JSON                | Descripci√≥n                      | Ejemplo                           |
| ---------------------------- | --------------------------------- | -----------------------------    |
| `addressInfo.addressLine1` | Calle y n√∫mero                    | `av insurgentes 1234`              |
| `addressInfo.addressLine2` | Informaci√≥n adicional (opcional)  | `interior 5` o `depto 202`         |
| `addressInfo.state`        | Estado                            | `ciudad de m√©xico`                 |
| `addressInfo.province`     | Alcald√≠a/Municipio                | `cuauht√©moc`                       |
| `addressInfo.district`     | Localidad                         | `condesa`                          |
| `addressInfo.latitude`     | Latitud                           | `19.4326`                          |
| `addressInfo.longitude`    | Longitud                          | `-99.1332`                         |
---

### üì¶ Sistema de Gesti√≥n de Paquetes en √ìrdenes de Transporte

#### Estructura de Paquetes

La API de √≥rdenes de transporte permite definir paquetes de dos maneras:

* **Paquetes con LPN (License Plate Number)**: identifican f√≠sicamente una unidad empaquetada.
* **Paquetes sin LPN**: representan agrupaciones l√≥gicas de √≠tems, tratadas como unidades entregables individuales.

---

#### üß† Generaci√≥n de Identificador √önico (DocID)

* Si el **paquete tiene LPN**, se utiliza dicho valor como clave para generar el `DocID`.
* Si el **paquete no tiene LPN**, el `DocID` es generado a partir de:

  * La referencia de la orden (`referenceID`),
  * El listado de SKUs ordenados de sus √≠tems, y
  * Un √≠ndice (`Index`) para distinguir agrupaciones repetidas de los mismos SKUs.

Este enfoque garantiza que cada paquete sin LPN tenga un identificador √∫nico, incluso cuando el mismo conjunto de √≠tems aparece m√°s de una vez.

---

#### üì¶ Sem√°ntica de Separaci√≥n de Paquetes

* **Separar √≠tems en distintos paquetes (sin LPN)** indica que **cada paquete representa una unidad entregable individual**.
* Si varios √≠tems van juntos como una √∫nica unidad de entrega, deben estar **dentro de un mismo paquete**.

---

#### Ejemplos

**Paquete con LPN:**

```json
{
  "lpn": "BOX-12345",
  "items": [
    {"sku": "PROD-A", "quantity": {"quantityNumber": 2, "quantityUnit": "unit"}},
    {"sku": "PROD-B", "quantity": {"quantityNumber": 1, "quantityUnit": "unit"}}
  ]
}
```

**Paquetes sin LPN ‚Äì √çtems separados como unidades entregables:**

```json
{
  "packages": [
    {"items": [{"sku": "PROD-A", "quantity": {"quantityNumber": 1, "quantityUnit": "unit"}}]},
    {"items": [{"sku": "PROD-B", "quantity": {"quantityNumber": 1, "quantityUnit": "unit"}}]}
  ]
}
```

---

#### ‚úÖ Resultado del Sistema

* El sistema genera un `DocID` para cada paquete (con o sin LPN).
* Cuando no hay LPN, el identificador se basa en los SKUs, la referencia de orden y un √≠ndice incremental si existen duplicados.
* Cada paquete sin LPN se considera una **unidad de entrega rastreable**.
