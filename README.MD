## transport-app

[![codecov](https://codecov.io/gh/Ignaciojeria/transport-app/branch/main/graph/badge.svg)](https://codecov.io/gh/Ignaciojeria/transport-app) [![Go Report Card](https://goreportcard.com/badge/github.com/Ignaciojeria/transport-app)](https://goreportcard.com/report/github.com/Ignaciojeria/transport-app)

## üìå Convenci√≥n de Campos para Direcciones en Chile

| Campo en JSON                | Descripci√≥n                      | Ejemplo                       |
| ---------------------------- | --------------------------------- | ----------------------------- |
| `addressInfo.addressLine1` | Calle y n√∫mero                    | `inglaterra 59`                    |
| `addressInfo.addressLine2` | Informaci√≥n adicional (opcional)  | `dpto 2214`                        |
| `addressInfo.district`     | Comuna                            | `la florida`                       |
| `addressInfo.province`     | Provincia                         | `santiago`                         |
| `addressInfo.state`        | Regi√≥n                            | `regi√≥n metropolitana de santiago` |
| `addressInfo.latitude`     | Latitud                           | `-33.5204181`                      |
| `addressInfo.longitude`    | Longitud                          | `-70.6006178`               |      
---

## üåê Ejemplos de Direcciones en Chile

### üè¢ Ejemplo en Santiago (con departamento)

```json
{
  "addressInfo": {
    "addressLine1": "av providencia 1234",
    "addressLine2": "depto 1202",
    "district": "providencia",
    "province": "santiago",
    "state": "regi√≥n metropolitana de santiago",
    "latitude": -33.4263,
    "longitude": -70.6200
  }
}
```

### üèôÔ∏è Ejemplo en Santiago (sin departamento)

```json
{
  "addressInfo": {
    "addressLine1": "avenida las condes 7890",
    "addressLine2": "",
    "district": "las condes",
    "province": "santiago",
    "state": "regi√≥n metropolitana de santiago",
    "latitude": -33.4085,
    "longitude": -70.5666
  }
}
```

# üîÑ Context Propagation in Transport App

En esta aplicaci√≥n utilizamos OpenTelemetry Baggage para propagar contexto entre componentes (API ‚Üí eventos Pub/Sub ‚Üí consumidores) de forma trazable, desacoplada y estandarizada.

---

## üßæ Headers del API

El consumidor de la API debe enviar los siguientes headers en cada request:

| Header         | Ejemplo              | Descripci√≥n                            |
|----------------|----------------------|----------------------------------------|
| `organization` | `2-CL`               | ID del tenant + pa√≠s (`tenantId-country`) |
| `consumer`     | `CONSUMER_EXAMPLE`   | Identificador del consumidor del API   |
| `commerce`     | `COMMERCE_EXAMPLE`   | Identificador del comercio             |

Estos headers son procesados por un middleware que:

- Desglosa el `organization` en `tenant.id` y `tenant.country`.
- Carga todos los valores como `baggage` en el contexto de OpenTelemetry.

---

## üß† OpenTelemetry Baggage Keys

Estas claves viven dentro del contexto propagado (`context.Context`) y son visibles desde trazas (Jaeger, OpenObserve, etc).

| Clave Baggage       | Ejemplo              | Fuente               |
|---------------------|----------------------|----------------------|
| `tenant.id`         | `2`                  | Derivado de `organization` |
| `tenant.country`    | `CL`                 | Derivado de `organization` |
| `business.consumer` | `CONSUMER_EXAMPLE`   | Header `consumer`    |
| `business.commerce` | `COMMERCE_EXAMPLE`   | Header `commerce`    |
| `event.type`        | `orderSubmitted`     | Inyectado por c√≥digo |
| `entity.type`       | `order`              | Inyectado por c√≥digo |

---

## üì¶ Pub/Sub Message Attributes

Cuando se publica un evento (como `orderSubmitted`), los atributos del contexto son exportados al mensaje en formato `camelCase`:

```json
{
  "tenantId": "2",
  "tenantCountry": "CL",
  "consumer": "CONSUMER_EXAMPLE",
  "commerce": "COMMERCE_EXAMPLE",
  "eventType": "orderSubmitted",
  "entityType": "order"
}
```

# üì¶ Sistema de Gesti√≥n de Paquetes en √ìrdenes de Transporte

## Estructura de Paquetes

La API de √≥rdenes de transporte permite definir paquetes de dos maneras diferentes:

1. **Paquetes con LPN (License Plate Number)**: Utilizados cuando existe una identificaci√≥n √∫nica para la unidad f√≠sica de entrega.
2. **Paquetes sin LPN**: Utilizados cuando los items deben ser tratados como entidades individuales o cuando no se dispone de una identificaci√≥n de embalaje.

### Ejemplos de Estructuras

#### Paquete con LPN Especificado

```json
{
    "dimensions": {
        "length": 10,
        "height": 10,
        "unit": "cm",
        "width": 10
    },
    "insurance": {
        "currency": "USD",
        "unitValue": 10
    },
    "items": [
        {
            "sku": "ITEM-001",
            "description": "Producto A",
            "dimensions": {
                "length": 1,
                "height": 1,
                "unit": "cm",
                "width": 1
            },
            "insurance": {
                "currency": "USD",
                "unitValue": 100
            },
            "logisticCondition": "normal",
            "quantity": {
                "quantityNumber": 1,
                "quantityUnit": "unit"
            },
            "weight": {
                "unit": "kg",
                "value": 0.5
            }
        }
    ],
    "lpn": "PKG-12345",
    "weight": {
        "unit": "kg",
        "value": 1
    }
}
```

#### Paquete sin LPN

```json
{
    "items": [
        {
            "sku": "ITEM-001",
            "description": "Producto A",
            "dimensions": {
                "length": 1,
                "height": 1,
                "unit": "cm",
                "width": 1
            },
            "insurance": {
                "currency": "USD",
                "unitValue": 100
            },
            "logisticCondition": "normal",
            "quantity": {
                "quantityNumber": 1,
                "quantityUnit": "unit"
            },
            "weight": {
                "unit": "kg",
                "value": 0.5
            }
        }
    ]
}
```

## Comportamiento del Sistema

### Manejo de Paquetes con LPN

Cuando un paquete incluye un valor LPN, este valor se utiliza como identificador principal para el paquete. El sistema:

- Utiliza el LPN para generar un identificador √∫nico (DocID) para el paquete
- Permite buscar, actualizar y seguir el paquete espec√≠ficamente por su LPN
- Considera el paquete como una unidad f√≠sica √∫nica que contiene todos los items listados

### Manejo de Paquetes sin LPN

Cuando un paquete se env√≠a sin LPN, el sistema:

1. **Generaci√≥n de identificador**: Genera un identificador √∫nico basado en:
   - La referencia de la orden (`referenceID`)
   - Los SKUs de los items contenidos en el paquete

2. **Tratamiento l√≥gico**: Trata el paquete como una unidad l√≥gica de entrega, donde:
   - Si hay un solo item: se considera como un item independiente
   - Si hay m√∫ltiples items: se consideran agrupados para entrega conjunta

3. **Trazabilidad**: Mantiene la trazabilidad a trav√©s del identificador generado, asegurando que:
   - Actualizaciones posteriores afecten al mismo conjunto de items
   - Se puedan realizar seguimientos coherentes aunque no exista un LPN expl√≠cito

4. **Consistencia**: Asegura que el mismo conjunto de items en la misma orden siempre genere el mismo identificador.

## Consideraciones para el Uso

### Cu√°ndo Usar Paquetes con LPN

- Cuando sus sistemas log√≠sticos asignan identificadores √∫nicos a los paquetes f√≠sicos
- Cuando necesita mantener consistencia con sistemas externos que utilizan LPNs
- Para seguimiento de alto nivel de unidades de env√≠o espec√≠ficas

### Cu√°ndo Usar Paquetes sin LPN

- Cuando trabaja con proveedores que no utilizan sistemas de codificaci√≥n de paquetes
- Cuando los items se transportan individualmente sin empaquetado conjunto
- Cuando solo necesita identificar los productos a entregar sin preocuparse por su agrupaci√≥n f√≠sica

## Ejemplos de Escenarios

### Escenario 1: M√∫ltiples Productos en un Paquete

Un pedido contiene tres productos diferentes que se embalan juntos:

```json
{
    "packages": [
        {
            "lpn": "BOX-12345",
            "items": [
                {"sku": "PROD-A", "quantity": {"quantityNumber": 2, "quantityUnit": "unit"}},
                {"sku": "PROD-B", "quantity": {"quantityNumber": 1, "quantityUnit": "unit"}},
                {"sku": "PROD-C", "quantity": {"quantityNumber": 3, "quantityUnit": "unit"}}
            ]
        }
    ]
}
```

### Escenario 2: Productos Individuales sin Embalaje Com√∫n

Un pedido contiene dos productos que se entregan de forma independiente:

```json
{
    "packages": [
        {
            "items": [
                {"sku": "PROD-X", "quantity": {"quantityNumber": 1, "quantityUnit": "unit"}}
            ]
        },
        {
            "items": [
                {"sku": "PROD-Y", "quantity": {"quantityNumber": 1, "quantityUnit": "unit"}}
            ]
        }
    ]
}
```

### Escenario 2.1: M√∫ltiples Items sin LPN

Un pedido con m√∫ltiples items en packages sin LPN:

```json
{
    "packages": [
        {
            "items": [
                {"sku": "PROD-X", "quantity": {"quantityNumber": 1, "quantityUnit": "unit"}},
                {"sku": "PROD-Z", "quantity": {"quantityNumber": 1, "quantityUnit": "unit"}}
            ]
        },
        {
            "items": [
                {"sku": "PROD-Y", "quantity": {"quantityNumber": 1, "quantityUnit": "unit"}}
            ]
        }
    ]
}
```

En este escenario:
- **Cada item se trata como una entidad entregable individual**
- Aunque PROD-X y PROD-Z aparecen en el mismo objeto del array, al no tener LPN, el sistema los procesar√° como entregas independientes
- La agrupaci√≥n en el mismo objeto es puramente para conveniencia en la API pero no implica empaquetado conjunto
- Este enfoque proporciona flexibilidad cuando no se conoce el empaquetado final

> **Nota importante**: Si los items deben ser entregados f√≠sicamente juntos como una unidad, se recomienda siempre asignar un LPN. La ausencia de LPN indica al sistema que los items son independientes para efectos log√≠sticos.

### Escenario 3: Mezcla de Paquetes con y sin LPN

Un pedido incluye tanto productos empaquetados como individuales:

```json
{
    "packages": [
        {
            "lpn": "BOX-A",
            "items": [
                {"sku": "PROD-1", "quantity": {"quantityNumber": 5, "quantityUnit": "unit"}},
                {"sku": "PROD-2", "quantity": {"quantityNumber": 2, "quantityUnit": "unit"}}
            ]
        },
        {
            "items": [
                {"sku": "PROD-3", "quantity": {"quantityNumber": 1, "quantityUnit": "unit"}}
            ]
        }
    ]
}
```

## Nota T√©cnica

El sistema autom√°ticamente genera identificadores de documento (DocID) para los paquetes utilizando una funci√≥n hash que garantiza la consistencia y unicidad de los identificadores. Para paquetes sin LPN, este identificador se basa en la combinaci√≥n de la referencia de orden y los SKUs de los items, lo que asegura que:

1. El mismo conjunto de items en la misma orden siempre genere el mismo identificador
2. Diferentes conjuntos de items o diferentes √≥rdenes generen identificadores distintos
3. El sistema pueda rastrear y actualizar correctamente los paquetes incluso sin un LPN expl√≠cito

Este enfoque proporciona flexibilidad para trabajar con diversos proveedores y escenarios log√≠sticos, manteniendo la integridad y trazabilidad del sistema.