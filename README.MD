# transport-app

[![codecov](https://codecov.io/gh/Ignaciojeria/transport-app/branch/main/graph/badge.svg)](https://codecov.io/gh/Ignaciojeria/transport-app)
[![Go Report Card](https://goreportcard.com/badge/github.com/Ignaciojeria/transport-app)](https://goreportcard.com/report/github.com/Ignaciojeria/transport-app)

---

## üîÑ Propagaci√≥n de Contexto en Transport App

Esta aplicaci√≥n utiliza OpenTelemetry Baggage para propagar contexto entre componentes (API ‚Üí eventos Pub/Sub ‚Üí consumidores) de forma trazable, desacoplada y estandarizada.

### üßæ Headers del API

El consumidor debe enviar los siguientes headers:

El consumidor debe enviar los siguientes headers:

| Header         | Ejemplo            | Descripci√≥n                                                                            |
| -------------- | ------------------ | -------------------------------------------------------------------------------------- |
| `organization` | `2-CL`             | ID del tenant + pa√≠s (`tenantId-country`). Siempre se utiliza para operar el recurso.  |
| `consumer`     | `CONSUMER_EXAMPLE` | Identificador t√©cnico de quien inicializ√≥ la creaci√≥n del recurso v√≠a API. (origen)             |
| `commerce`     | `COMMERCE_EXAMPLE` | Identificador del comercio o tienda que genera la necesidad inicial de operar el recurso.       |
| `channel`      | `WEB` / `APP`      | Canal de operaci√≥n previo a creaci√≥n del recurso (planificado : Web, Entregado: App Mobile, etc.). Puede cambiar. |

Estos headers son procesados por un middleware que los desglosa e inyecta como baggage en el contexto de OpenTelemetry.

### üß† OpenTelemetry Baggage Keys

Estas claves se propagan en el `context.Context`:

| Clave Baggage       | Ejemplo                  | Fuente                     |
| ------------------- | ------------------------ | -------------------------- |
| `tenant.id`         | `2`                      | Derivado de `organization` |
| `tenant.country`    | `CL`                     | Derivado de `organization` |
| `business.consumer` | `CONSUMER_EXAMPLE`       | Header `consumer`          |
| `business.commerce` | `COMMERCE_EXAMPLE`       | Header `commerce`          |
| `business.channel`  | `WEB/MOBILE/INTEGRATION` | Header `channel`           |
| `event.type`        | `orderSubmitted`         | Inyectado por c√≥digo       |
| `entity.type`       | `order`                  | Inyectado por c√≥digo       |

### üì¶ Pub/Sub Message Attributes

Al publicar un evento como `orderSubmitted`, los atributos se propagan como:

```json
{
  "tenantId": "2",
  "tenantCountry": "CL",
  "consumer": "CONSUMER_EXAMPLE",
  "commerce": "COMMERCE_EXAMPLE",
  "eventType": "orderSubmitted",
  "entityType": "order"
}
```

---

## üìå Convenci√≥n de Direcciones

### Chile

| Campo JSON              | Descripci√≥n    | Ejemplo                            |
| ----------------------- | -------------- | ---------------------------------- |
| `addressLine1`          | Calle y n√∫mero | `inglaterra 59`                    |
| `addressLine2`          | Info adicional | `dpto 2214`                        |
| `district`              | Comuna         | `la florida`                       |
| `province`              | Provincia      | `santiago`                         |
| `state`                 | Regi√≥n         | `regi√≥n metropolitana de santiago` |
| `latitude`, `longitude` | Coordenadas    | `-33.5204181`, `-70.6006178`       |

### M√©xico

| Campo JSON              | Descripci√≥n        | Ejemplo               |
| ----------------------- | ------------------ | --------------------- |
| `addressLine1`          | Calle y n√∫mero     | `av insurgentes 1234` |
| `addressLine2`          | Info adicional     | `interior 5`          |
| `district`              | Localidad          | `condesa`             |
| `province`              | Alcald√≠a/Municipio | `cuauht√©moc`          |
| `state`                 | Estado             | `ciudad de m√©xico`    |
| `latitude`, `longitude` | Coordenadas        | `19.4326`, `-99.1332` |

---

## üì¶ Sistema de Gesti√≥n de Paquetes

### Tipos de Paquetes

* **Con LPN:** El campo `lpn` es un identificador √∫nico f√≠sico.
* **Sin LPN:** Los √≠tems se tratan como agrupaciones l√≥gicas.

### Generaci√≥n de DocID

* **Con LPN:** Se usa directamente `HashByTenant(ctx, lpn)`.
* **Sin LPN:** Se usa:

  * La referencia de la orden (`referenceID`)
  * Lista de SKUs de los √≠tems (ordenados)
  * Un √≠ndice (`Index`) si hay paquetes con los mismos SKUs

Esto garantiza que:

* Un conjunto id√©ntico de √≠tems genera el mismo DocID
* Cambios en √≠tems o √≠ndice generan un nuevo DocID

### Separaci√≥n de Unidades Entregables

Dividir los √≠tems en distintos paquetes sin LPN indica que cada paquete ser√° una **unidad entregable**.

---

## üß™ Ejemplos

### Paquete con LPN

```json
{
  "lpn": "PKG-12345",
  "dimensions": {"length": 10, "height": 10, "width": 10, "unit": "cm"},
  "weight": {"value": 1, "unit": "kg"},
  "insurance": {"currency": "USD", "unitValue": 10},
  "items": [
    {
      "sku": "ITEM-001",
      "description": "Producto A",
      "quantity": {"quantityNumber": 1, "quantityUnit": "unit"},
      "weight": {"value": 0.5, "unit": "kg"},
      "dimensions": {"length": 1, "height": 1, "width": 1, "unit": "cm"},
      "insurance": {"currency": "USD", "unitValue": 100}
    }
  ]
}
```

### Paquetes sin LPN ‚Äì √çtems separados como unidades entregables

```json
{
  "packages": [
    {"items": [{"sku": "PROD-A", "quantity": {"quantityNumber": 1, "quantityUnit": "unit"}}]},
    {"items": [{"sku": "PROD-B", "quantity": {"quantityNumber": 1, "quantityUnit": "unit"}}]}
  ]
}
```

### Paquete sin LPN ‚Äì √çtems agrupados como una unidad entregable

```json
{
  "packages": [
    {
      "items": [
        {"sku": "PROD-A", "quantity": {"quantityNumber": 1, "quantityUnit": "unit"}},
        {"sku": "PROD-B", "quantity": {"quantityNumber": 1, "quantityUnit": "unit"}}
      ]
    }
  ]
}
```

---

## üß† Conclusi√≥n

* Los paquetes con LPN tienen trazabilidad directa.
* Los paquetes sin LPN se identifican por los SKUs ordenados, la referencia y un √≠ndice si corresponde.
* La estructura del JSON refleja directamente la granularidad de entrega esperada.
* Separar √≠tems en distintos paquetes sin LPN implica que ser√°n tratados como entregas independientes.

Esto otorga gran flexibilidad al sistema para representar diversos escenarios log√≠sticos.


# üì¶ Consulta GraphQL para Delivery Units (Relay Style)

Este sistema expone una API GraphQL basada en la especificaci√≥n **Relay** para gestionar consultas de unidades entregables (Delivery Units).

## üöÄ Query: Obtener Delivery Units

```graphql
query GetDeliveryUnitsReports(
  $filter: DeliveryUnitsReportFilterInput, 
  $first: Int, 
  $after: String
) {
  deliveryUnitsReports(
    filter: $filter,
    first: $first,
    after: $after
  ) {
    edges {
      cursor
      node {
        referenceID
        collectAvailabilityDate {
          date
          timeRange {
            startTime
            endTime
          }
        }
        destination {
          addressInfo {
            addressLine1
            addressLine2
            contact {
              additionalContactMethods {
                type
                value
              }
              documents {
                type
                value
              }
              email
              fullName
              nationalID
              phone
            }
            district
            latitude
            longitude
            province
            state
            timeZone
            zipCode
          }
          deliveryInstructions
          nodeInfo {
            referenceId
            name
          }
        }
        origin {
          addressInfo {
            addressLine1
            addressLine2
            contact {
              additionalContactMethods {
                type
                value
              }
              documents {
                type
                value
              }
              email
              fullName
              nationalID
              phone
            }
            district
            latitude
            longitude
            province
            state
            timeZone
            zipCode
          }
          deliveryInstructions
          nodeInfo {
            referenceId
            name
          }
        }
        orderType {
          type
          description
        }
        package {
          dimensions {
            length
            height
            width
            unit
          }
          insurance {
            currency
            unitValue
          }
          items {
            sku
            description
            dimensions {
              length
              height
              width
              unit
            }
            insurance {
              currency
              unitValue
            }
            skills {
              type
              value
              description
            }
            quantity {
              quantityNumber
              quantityDelivered
              quantityUnit
            }
            weight {
              unit
              value
            }
          }
          labels {
            type
            value
          }
          lpn
          weight {
            unit
            value
          }
        }
        promisedDate {
          dateRange {
            startDate
            endDate
          }
          serviceCategory
          timeRange {
            startTime
            endTime
          }
        }
        references {
          type
          value
        }
        extraFields {
          key
          value
        }
        carrier {
          nationalID
          name
        }
        vehicle {
          plate
        }
        driver {
          nationalID
          name
          email
        }
        route {
          routeID
          routePosition
        }
        delivery {
          status
          handledAt
          failure {
            detail
            reason
            referenceID
          }
          location {
            latitude
            longitude
          }
          recipient {
            fullName
            nationalID
          }
        }
      }
    }
    pageInfo {
      hasNextPage
      endCursor
    }
  }
}
```

## üìñ Consideraciones importantes

* **Relay Style:** La API utiliza el patr√≥n Relay para manejar paginaci√≥n (`edges`, `cursor`, `pageInfo`).
* **PageInfo:** Permite saber si hay m√°s resultados (`hasNextPage`) y avanzar (`endCursor`).

Con esta estructura puedes construir reportes log√≠sticos detallados, dashboards de entregas, o integraciones hacia otros sistemas de monitoreo.
