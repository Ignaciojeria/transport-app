# transport-app

[![codecov](https://codecov.io/gh/Ignaciojeria/transport-app/branch/main/graph/badge.svg)](https://codecov.io/gh/Ignaciojeria/transport-app)
[![Go Report Card](https://goreportcard.com/badge/github.com/Ignaciojeria/transport-app)](https://goreportcard.com/report/github.com/Ignaciojeria/transport-app)

---

# üó∫Ô∏è Optimizaci√≥n de rutas con OSRM + VROOM

Este entorno Docker permite levantar una instancia local de **OSRM** para ruteo y **VROOM** para optimizaci√≥n de rutas de √∫ltima milla. Ideal para SaaS log√≠sticos, simulaciones o soluciones descentralizadas.

## üì¶ Requisitos

- Docker
- Docker Compose
- Conexi√≥n a Internet para descargar los mapas

## üìÅ Estructura del proyecto

```
.
‚îú‚îÄ‚îÄ docker-compose.yml
‚îî‚îÄ‚îÄ osrm/
    ‚îî‚îÄ‚îÄ chile-latest.osm.pbf      # Archivo del mapa descargado manualmente
```

## üåç Paso 1: Descargar el mapa de Chile

```bash
mkdir -p ./osrm
curl -L https://download.geofabrik.de/south-america/chile-latest.osm.pbf -o ./osrm/chile-latest.osm.pbf
```

Puedes cambiar el pa√≠s o regi√≥n desde: https://download.geofabrik.de/

## üê≥ Paso 2: Levantar los servicios

```bash

‚úÖ Comandos para levantar cada entorno

üîß Solo backend (desarrollo, sin transport-app)
docker-compose -f docker-compose.yml up

üöÄ Producci√≥n (con transport-app)
docker-compose -f docker-compose.allinone.yml pull
docker-compose -f docker-compose.allinone.yml up 

Aqu√≠ docker-compose.allinone.yml agrega transport-app al conjunto de servicios, sin necesidad de duplicar el resto.
```


# JWT Setup Guide - Transport App

## üîë Generaci√≥n de Claves RSA

### **Requisitos previos:**
- OpenSSL instalado en el sistema
- Acceso a terminal/PowerShell

### **Comandos para generar claves JWT y exponer .well-known/jwks.json:**
Estos comandos generan una clave privada y su clave p√∫blica correspondiente, necesarias para firmar tokens JWT y exponer tu endpoint .well-known/jwks.json como Authorization Server.
```bash
# Generar clave privada PKCS#8
openssl genpkey -algorithm RSA -out private_key.pem -pkeyopt rsa_keygen_bits:2048

# Extraer clave p√∫blica
openssl rsa -pubout -in private_key.pem -out public_key.pem
```

## üîê Comando para generar clave de encriptaci√≥n de Client Credentials (AES-256-GCM)
Esta clave se utiliza para encriptar y desencriptar los client_secret antes de almacenarlos en la base de datos.
```bash
# Generar 32 bytes aleatorios en Base64 (clave de 256 bits)
openssl rand -base64 32
```

Esto ejecutar√°:

- **OSRM**: procesar√° `chile-latest.osm.pbf` (extract ‚Üí partition ‚Üí customize) y servir√° en `http://localhost:5000`
- **VROOM**: se conectar√° a OSRM y servir√° en `http://localhost:3000`

## ‚úÖ Verificaci√≥n de estado

```bash
# Verifica OSRM
curl "http://localhost:5000/route/v1/driving/-70.65,-33.45;-70.66,-33.46"

# Verifica VROOM Powershell
$body = '{"jobs":[{"id":1,"location":[-70.6483,-33.4372]}],"vehicles":[{"id":1,"start":[-70.6483,-33.4372]}]}'
Invoke-RestMethod -Uri "http://localhost:3000/" -Method Post -Body $body -ContentType "application/json"
```

## üì§ Ejemplo de solicitud a VROOM

```bash
curl -X POST http://localhost:3000 \
  -H "Content-Type: application/json" \
  -d '{
    "vehicles": [{ "id": 1, "start": [ -70.653, -33.45 ] }],
    "jobs": [
      { "id": 1, "location": [ -70.65, -33.44 ] },
      { "id": 2, "location": [ -70.66, -33.46 ] }
    ]
  }'
```

## ‚öôÔ∏è Personalizaci√≥n

- Cambia el mapa reemplazando `chile-latest.osm.pbf` en `./osrm/`.
- Puedes modificar `car.lua` para ajustar reglas de tr√°fico.
- VROOM permite una configuraci√≥n avanzada v√≠a `config.yml`.

## üß© Extensiones posibles

- Convertir en sidecar para microservicio de optimizaci√≥n.
- Usar `zrok` para habilitar nodos descentralizados P2P.
- Integrar sistema de staking y recompensas basado en rendimiento.
- Registrar nodos v√≠a healthcheck en un SaaS log√≠stico.


## üîÑ Propagaci√≥n de Contexto en Transport App

Esta aplicaci√≥n utiliza OpenTelemetry Baggage para propagar contexto entre componentes (API ‚Üí eventos Pub/Sub ‚Üí consumidores) de forma trazable, desacoplada y estandarizada.

### üßæ Headers del API

El consumidor debe enviar los siguientes headers:

El consumidor debe enviar los siguientes headers:

| Header         | Ejemplo            | Descripci√≥n                                                                            |
| -------------- | ------------------ | -------------------------------------------------------------------------------------- |
| `tenant`       | `53f0cea9-ee4c-4c0f-adc8-dabc850e4d7b-CL`             | ID del tenant + pa√≠s (`tenantId-country`). Siempre se utiliza para operar el recurso.  |
| `consumer`     | `CONSUMER_EXAMPLE` | Identificador t√©cnico de quien inicializ√≥ la creaci√≥n del recurso v√≠a API. (origen)             |
| `commerce`     | `COMMERCE_EXAMPLE` | Identificador del comercio o tienda que genera la necesidad inicial de operar el recurso.       |
| `channel`      | `WEB` / `APP` / `YOUR_API_SERVICE`      | Canal de operaci√≥n previo a creaci√≥n del recurso (planificado : Web, Entregado: App Mobile, etc.). Puede cambiar. |

Estos headers son procesados por un middleware que los desglosa e inyecta como baggage en el contexto de OpenTelemetry.

### üß† OpenTelemetry Baggage Keys

Estas claves se propagan en el `context.Context`:

| Clave Baggage       | Ejemplo                  | Fuente                     |
| ------------------- | ------------------------ | -------------------------- |
| `tenant.id`         | `2`                      | Derivado de `tenant` |
| `tenant.country`    | `CL`                     | Derivado de `tenant` |
| `consumer`          | `CONSUMER_EXAMPLE`       | Header `consumer`          |
| `commerce`          | `COMMERCE_EXAMPLE`       | Header `commerce`          |
| `channel`           | `WEB/MOBILE/INTEGRATION` | Header `channel`           |
| `event.type`        | `orderSubmitted`         | Inyectado por c√≥digo       |
| `entity.type`       | `order`                  | Inyectado por c√≥digo       |

### üì¶ Pub/Sub Message Attributes

Al publicar un evento como `orderSubmitted`, los atributos se propagan como:

```json
{
  "tenantId": "2",
  "tenantCountry": "CL",
  "consumer": "CONSUMER_EXAMPLE",
  "commerce": "COMMERCE_EXAMPLE",
  "eventType": "orderSubmitted",
  "entityType": "order"
}
```

---

## üìå Convenci√≥n de Direcciones

### Chile

| Campo JSON              | Descripci√≥n    | Ejemplo                            |
| ----------------------- | -------------- | ---------------------------------- |
| `addressLine1`          | Calle y n√∫mero | `inglaterra 59`                    |
| `addressLine2`          | Info adicional | `dpto 2214`                        |
| `district`              | Comuna         | `la florida`                       |
| `province`              | Provincia      | `santiago`                         |
| `state`                 | Regi√≥n         | `region metropolitana de santiago` |
| `latitude`, `longitude` | Coordenadas    | `-33.5204181`, `-70.6006178`       |

### M√©xico

| Campo JSON              | Descripci√≥n        | Ejemplo               |
| ----------------------- | ------------------ | --------------------- |
| `addressLine1`          | Calle y n√∫mero     | `av insurgentes 1234` |
| `addressLine2`          | Info adicional     | `interior 5`          |
| `district`              | Localidad          | `condesa`             |
| `province`              | Alcald√≠a/Municipio | `cuauht√©moc`          |
| `state`                 | Estado             | `ciudad de m√©xico`    |
| `latitude`, `longitude` | Coordenadas        | `19.4326`, `-99.1332` |

---

## Filtros

### CoordinatesConfidenceLevel

üéØ **Filtros y resultados esperados**

| Filtro Min     | Filtro Max     | Resultado esperado (IDs) | L√≥gica SQL aplicada                                      |
|----------------|----------------|---------------------------|-----------------------------------------------------------|
| *(sin filtro)* | *(sin filtro)* | A, B, C, D, E, F          | No se aplica condici√≥n (`WHERE 1=1`)                      |
| 0.5            | *(sin filtro)* | C, D, E, F                | `level >= 0.5`                                            |
| *(sin filtro)* | 0.5            | A, B                      | `level <= 0.5`                                            |
| 0.5            | 0.8            | C, D                      | `level >= 0.5 AND level <= 0.8`                           |
| 0.7            | 0.7            | *(vac√≠o)*                 | `level >= 0.7 AND level <= 0.7` (match exacto)            |
| 1.1            | *(sin filtro)* | *(vac√≠o)*                 | `level >= 1.1` (ning√∫n registro cumple)                   |
| *(sin filtro)* | 0.0            | *(vac√≠o)*                 | `level <= 0.0` (ning√∫n registro cumple)                   |
| 0.0            | 1.0            | A, B, C, D, E, F          | `level >= 0.0 AND level <= 1.0` (todos los registros)     |


## üì¶ Sistema de Gesti√≥n de Paquetes

### Tipos de Paquetes

* **Con LPN:** El campo `lpn` es un identificador √∫nico f√≠sico.
* **Sin LPN:** Los √≠tems se tratan como agrupaciones l√≥gicas.

### Generaci√≥n de DocID

* **Con LPN:** Se usa directamente `HashByTenant(ctx, lpn)`.
* **Sin LPN:** Se usa:

  * La referencia de la orden (`referenceID`)
  * Lista de SKUs de los √≠tems (ordenados)
  * Un √≠ndice (`Index`) si hay paquetes con los mismos SKUs

Esto garantiza que:

* Un conjunto id√©ntico de √≠tems genera el mismo DocID
* Cambios en √≠tems o √≠ndice generan un nuevo DocID

### Separaci√≥n de Unidades Entregables

Dividir los √≠tems en distintos paquetes sin LPN indica que cada paquete ser√° una **unidad entregable**.

---

## üß™ Ejemplos

### Paquete con LPN

```json
{
  "lpn": "PKG-12345",
  "dimensions": {"length": 10, "height": 10, "width": 10, "unit": "cm"},
  "weight": {"value": 1, "unit": "kg"},
  "insurance": {"currency": "USD", "unitValue": 10},
  "items": [
    {
      "sku": "ITEM-001",
      "description": "Producto A",
      "quantity": {"quantityNumber": 1, "quantityUnit": "unit"},
      "weight": {"value": 0.5, "unit": "kg"},
      "dimensions": {"length": 1, "height": 1, "width": 1, "unit": "cm"},
      "insurance": {"currency": "USD", "unitValue": 100}
    }
  ]
}
```

### Paquetes sin LPN ‚Äì √çtems separados como unidades entregables

```json
{
  "packages": [
    {"items": [{"sku": "PROD-A", "quantity": {"quantityNumber": 1, "quantityUnit": "unit"}}]},
    {"items": [{"sku": "PROD-B", "quantity": {"quantityNumber": 1, "quantityUnit": "unit"}}]}
  ]
}
```

### Paquete sin LPN ‚Äì √çtems agrupados como una unidad entregable

```json
{
  "packages": [
    {
      "items": [
        {"sku": "PROD-A", "quantity": {"quantityNumber": 1, "quantityUnit": "unit"}},
        {"sku": "PROD-B", "quantity": {"quantityNumber": 1, "quantityUnit": "unit"}}
      ]
    }
  ]
}
```

---

## üß† Conclusi√≥n

* Los paquetes con LPN tienen trazabilidad directa.
* Los paquetes sin LPN se identifican por los SKUs ordenados, la referencia y un √≠ndice si corresponde.
* La estructura del JSON refleja directamente la granularidad de entrega esperada.
* Separar √≠tems en distintos paquetes sin LPN implica que ser√°n tratados como entregas independientes.

Esto otorga gran flexibilidad al sistema para representar diversos escenarios log√≠sticos.


# üì¶ Consulta GraphQL para Delivery Units (Relay Style)

Este sistema expone una API GraphQL basada en la especificaci√≥n **Relay** para gestionar consultas de unidades entregables (Delivery Units).

## üöÄ Query: Obtener Delivery Units

```graphql
query GetDeliveryUnitsReports(
  $filter: DeliveryUnitsReportFilterInput, 
  $first: Int, 
  $after: String
) {
  deliveryUnitsReports(
    filter: $filter,
    first: $first,
    after: $after
  ) {
    edges {
      cursor
      node {
        referenceID
        collectAvailabilityDate {
          date
          timeRange {
            startTime
            endTime
          }
        }
        destination {
          addressInfo {
            addressLine1
            addressLine2
            contact {
              additionalContactMethods {
                type
                value
              }
              documents {
                type
                value
              }
              email
              fullName
              nationalID
              phone
            }
            district
            latitude
            longitude
            province
            state
            timeZone
            zipCode
          }
          deliveryInstructions
          nodeInfo {
            referenceId
            name
          }
        }
        origin {
          addressInfo {
            addressLine1
            addressLine2
            contact {
              additionalContactMethods {
                type
                value
              }
              documents {
                type
                value
              }
              email
              fullName
              nationalID
              phone
            }
            district
            latitude
            longitude
            province
            state
            timeZone
            zipCode
          }
          deliveryInstructions
          nodeInfo {
            referenceId
            name
          }
        }
        orderType {
          type
          description
        }
        package {
          dimensions {
            length
            height
            width
            unit
          }
          insurance {
            currency
            unitValue
          }
          items {
            sku
            description
            dimensions {
              length
              height
              width
              unit
            }
            insurance {
              currency
              unitValue
            }
            skills {
              type
              value
              description
            }
            quantity {
              quantityNumber
              quantityDelivered
              quantityUnit
            }
            weight {
              unit
              value
            }
          }
          labels {
            type
            value
          }
          lpn
          weight {
            unit
            value
          }
        }
        promisedDate {
          dateRange {
            startDate
            endDate
          }
          serviceCategory
          timeRange {
            startTime
            endTime
          }
        }
        references {
          type
          value
        }
        extraFields {
          key
          value
        }
        carrier {
          nationalID
          name
        }
        vehicle {
          plate
        }
        driver {
          nationalID
          name
          email
        }
        route {
          routeID
          routePosition
        }
        delivery {
          status
          handledAt
          failure {
            detail
            reason
            referenceID
          }
          location {
            latitude
            longitude
          }
          recipient {
            fullName
            nationalID
          }
        }
      }
    }
    pageInfo {
      hasNextPage
      endCursor
    }
  }
}
```

## üìñ Consideraciones importantes

* **Relay Style:** La API utiliza el patr√≥n Relay para manejar paginaci√≥n (`edges`, `cursor`, `pageInfo`).
* **PageInfo:** Permite saber si hay m√°s resultados (`hasNextPage`) y avanzar (`endCursor`).

Con esta estructura puedes construir reportes log√≠sticos detallados, dashboards de entregas, o integraciones hacia otros sistemas de monitoreo.